#!/bin/bash

################################################################
# run - Lobster Notes startup script
# Starts MySQL database, Flask backend, and Vite frontend
#
# Author: Nikki Gorski (Lobster Notes Team, 2025)
################################################################

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$SCRIPT_DIR"
PORTABLE_DIR="$PROJECT_ROOT/.portable"
NODE_PORTABLE="$PORTABLE_DIR/node"

# Add portable Node.js to PATH if it exists
if [ -d "$NODE_PORTABLE/bin" ]; then
    export PATH="$NODE_PORTABLE/bin:$PATH"
fi

# MySQL configuration - use environment variables with defaults
MYSQL_HOME="${MYSQL_HOME:-$HOME/mysql}"

# Auto-detect MySQL/MariaDB binary location - prefer system installation
MYSQL_BIN="${MYSQL_BIN:-$(command -v mysqld_safe 2>/dev/null || command -v mariadb-safe 2>/dev/null || echo $MYSQL_HOME/bin/mysqld_safe)}"

MYSQL_CONFIG="$PROJECT_ROOT/sql-commands-and-backend/my.cnf"
MYSQL_DATADIR="$PROJECT_ROOT/sql-commands-and-backend/database"

# Auto-detect MySQL socket location
socket_paths=(
    "$HOME/mysql.sock"
    "/tmp/mysql.sock"
    "/var/run/mysqld/mysql.sock"
)
MYSQL_SOCKET=""
for path in "${socket_paths[@]}"; do
    if [ -S "$path" ] 2>/dev/null; then
        MYSQL_SOCKET="$path"
        break
    fi
done
# Default to first choice if none found
MYSQL_SOCKET="${MYSQL_SOCKET:-$HOME/mysql.sock}"
INIT_SCRIPT="$PROJECT_ROOT/sql-commands-and-backend/init_db.sh"
VENV_PATH="$PROJECT_ROOT/lobsterenv/bin/activate"
BACKEND_DIR="$PROJECT_ROOT/Phase 3/backend"
FRONTEND_DIR="$PROJECT_ROOT/frontend"

echo "================================================================"
echo "Starting Lobster Notes Application"
echo "================================================================"

# Set up library path for MySQL (needed for libaio)
export LD_LIBRARY_PATH="$HOME/libaio-0.3.113/src:$MYSQL_HOME/lib:$LD_LIBRARY_PATH"

# Set up library path for MySQL (needed for libaio)
export LD_LIBRARY_PATH="$HOME/libaio-0.3.113/src:$MYSQL_HOME/lib:$LD_LIBRARY_PATH"

# Check if MySQL is already running
if pgrep -x "mysqld" > /dev/null; then
    echo "[MySQL] Already running"
else
    if [ -f "$MYSQL_BIN" ] && command -v "$MYSQL_BIN" &>/dev/null; then
        echo "[MySQL] Starting database server..."
        $MYSQL_BIN --defaults-file=$MYSQL_CONFIG --datadir=$MYSQL_DATADIR --socket=$MYSQL_SOCKET &
        sleep 3
    else
        echo "[MySQL] WARNING: MySQL binary not found at $MYSQL_BIN"
        echo "[MySQL] Trying to connect to existing MySQL server at socket: $MYSQL_SOCKET"
    fi
fi

# Initialize database
if [ -f "$INIT_SCRIPT" ]; then
    echo "[Database] Running initialization script..."
    bash $INIT_SCRIPT 2>/dev/null || echo "[Database] Initialization skipped"
else
    echo "[Database] Skipping initialization - script not found"
fi

# Import Khan Academy data
if [ -f "$VENV_PATH" ] && [ -f "$PROJECT_ROOT/sql-commands-and-backend/import_khan_data.py" ]; then
    echo "[Database] Importing Khan Academy notes data..."
    source $VENV_PATH 2>/dev/null
    export LD_LIBRARY_PATH="$MYSQL_HOME/lib:$LD_LIBRARY_PATH"
    python3 "$PROJECT_ROOT/sql-commands-and-backend/import_khan_data.py" 2>/dev/null || echo "[Database] Khan Academy import skipped"
else
    echo "[Database] Skipping Khan Academy import - files not found"
fi

# Start Flask backend
if [ -d "$BACKEND_DIR" ] && [ -f "$BACKEND_DIR/app.py" ]; then
    echo "[Backend] Starting Flask API server..."
    cd "$BACKEND_DIR"
    if [ -f "$VENV_PATH" ]; then
        source "$VENV_PATH" 2>/dev/null
        export LD_LIBRARY_PATH="$MYSQL_HOME/lib:$LD_LIBRARY_PATH"
        python3 app.py &
        BACKEND_PID=$!
        echo "[Backend] Flask running on http://127.0.0.1:8080 (PID: $BACKEND_PID)"
    else
        echo "[Backend] WARNING: Virtual environment not found at $VENV_PATH"
        BACKEND_PID=""
    fi
else
    echo "[Backend] Skipping Flask - backend directory or app.py not found"
    BACKEND_PID=""
fi

# Start Vite frontend
if [ -d "$FRONTEND_DIR" ] && [ -f "$FRONTEND_DIR/package.json" ]; then
    echo "[Frontend] Starting Vite development server..."
    cd "$FRONTEND_DIR"
    npm run dev &
    FRONTEND_PID=$!
    echo "[Frontend] Vite running on http://localhost:5173 (PID: $FRONTEND_PID)"
else
    echo "[Frontend] Skipping Vite - frontend directory or package.json not found"
    FRONTEND_PID=""
fi

echo "================================================================"
echo "Lobster Notes started successfully!"
echo "================================================================"
echo "MySQL:    Running"
echo "Backend:  http://127.0.0.1:8080"
echo "Frontend: http://localhost:5173"
echo ""
echo "Press Ctrl+C to stop all services"
echo "================================================================"

# Wait for user interrupt
if [ -n "$BACKEND_PID" ] || [ -n "$FRONTEND_PID" ]; then
    trap "echo ''; echo 'Stopping services...'; kill $BACKEND_PID $FRONTEND_PID 2>/dev/null; exit 0" SIGINT SIGTERM
    wait
else
    echo "No services started. Exiting."
    exit 1
fi
